name: Auto commit

on:
  push:
    branches:
      - master
      
  schedule:
    - cron: "0 * * * *"  # Run every hour

jobs:
  auto_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Git config
        run: |
          git config --local user.email "pertamax134@gmail.com"
          git config --local user.name "arturafriansyah"

      - name: Setup daily run hour
        run: |
          today=$(date '+%Y-%m-%d')
          hour_file=".daily_run_hour"

          # Cek apakah file ada dan apakah untuk hari ini
          if [ -f "$hour_file" ]; then
            file_date=$(cut -d',' -f1 "$hour_file")
            if [ "$file_date" != "$today" ]; then
              rm "$hour_file"
            fi
          fi

          # Jika belum ada, generate dan simpan
          if [ ! -f "$hour_file" ]; then
            hour=$((RANDOM % 13 + 8))
            echo "$today,$hour" > "$hour_file"
            echo "🕒 Generated run hour: $hour"

            # Commit file .daily_run_hour
            git add "$hour_file"
            git commit -m "chore(bot): set daily run hour to $hour for $today"
            git push origin master
          else
            hour=$(cut -d',' -f2 "$hour_file")
            echo "🕒 Loaded run hour from file: $hour"
          fi

          # Ambil jam sekarang dan bandingkan
          now=$(date +%H | sed 's/^0*//')
          if [ "$now" -ne "$hour" ]; then
            echo "⏰ Now is $now, not the scheduled run hour $hour. Skipping."
            exit 0
          fi

      - name: Modify last update
        run: |
          d=`date '+%Y-%m-%dT%H:%M:%SZ'`
          echo $d > LAST_UPDATED

      - name: Commit auto update
        run: |
          arr[0]="chore(bot): 😂 auto commit"
          arr[1]="chore(bot): 😱 auto commit"
          arr[2]="chore(bot): 👿 auto commit"
          arr[3]="chore(bot): 💩 auto commit"
          arr[4]="chore(bot): 🙏 auto commit"
          arr[5]="chore(bot): 🙈 auto commit"
          arr[6]="chore(bot): 🐐 auto commit"
          arr[7]="chore(bot): 🤖 auto commit"
          arr[8]="chore(bot): 🟩 auto commit"
          arr[9]="chore(bot): 👻 auto commit"

          rand=$[$RANDOM % ${#arr[@]}]
          git add LAST_UPDATED
          git commit -m "${arr[$rand]}" || echo "⚠️ Nothing to commit"
          git push origin master
